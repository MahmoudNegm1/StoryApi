# ============================================================
# COMMANDS TO RUN ON YOUR HOSTINGER VPS TO FIX THE RATE LIMIT
# ============================================================

# Step 1: Navigate to your project directory
cd /home/apiuser/apps/StoryApi

# Step 2: Backup the original file
cp Codes/image_processor.py Codes/image_processor.py.backup

# Step 3: Replace the for loop section in image_processor.py
# The key changes are:
# - Line 428: for idx, filename in enumerate(all_images):
# - Lines 440-442: Add delay between API calls
# - Lines 449-466: Add retry logic with 3 attempts

# Step 4: Create a patch file with these exact changes:

cat > /tmp/fix_patch.py << 'PATCH_EOF'
import re

# Read the file
with open('Codes/image_processor.py', 'r') as f:
    content = f.read()

# Find and replace the for loop section
old_code = '''    for filename in all_images:
        name_no_ext = os.path.splitext(filename)[0]
        out_path = os.path.join(char_output_folder, f"{name_no_ext}.jpg")

        is_api = filename in api_images
        src_path = os.path.join(api_images_folder if is_api else normal_images_folder, filename)

        # Skip if already exists
        if not os.path.exists(out_path):
            if is_api:
                from Codes.api_segmiod import perform_head_swap
                os.environ["SEGMIND_INTERACTIVE"] = "0"
                os.environ["SEGMIND_SINGLE_ATTEMPT"] = "1"
                os.environ["SEGMIND_ATTEMPT_INDEX"] = "1"
                os.environ["SEGMIND_NO_TRY_FILES"] = "1"

                preview = perform_head_swap(
                    target_image_path=src_path,
                    face_image_path=character_image_path,
                    output_filename=out_path,
                    face_url_cached=None,
                )
                if preview and os.path.exists(preview):
                    out_path = preview

                os.environ["SEGMIND_SINGLE_ATTEMPT"] = "0"
                os.environ["SEGMIND_NO_TRY_FILES"] = "0"
                os.environ.pop("SEGMIND_ATTEMPT_INDEX", None)
            else:
                shutil.copyfile(src_path, out_path)'''

new_code = '''    for idx, filename in enumerate(all_images):
        name_no_ext = os.path.splitext(filename)[0]
        out_path = os.path.join(char_output_folder, f"{name_no_ext}.jpg")

        is_api = filename in api_images
        src_path = os.path.join(api_images_folder if is_api else normal_images_folder, filename)

        # Skip if already exists
        if not os.path.exists(out_path):
            if is_api:
                from Codes.api_segmiod import perform_head_swap
                
                # Add delay between API calls to avoid rate limiting
                if idx > 0:
                    time.sleep(2)  # 2 second delay between API calls
                
                os.environ["SEGMIND_INTERACTIVE"] = "0"
                os.environ["SEGMIND_SINGLE_ATTEMPT"] = "1"
                os.environ["SEGMIND_ATTEMPT_INDEX"] = "1"
                os.environ["SEGMIND_NO_TRY_FILES"] = "1"

                preview = None
                # Retry logic for API failures (rate limiting)
                for attempt in range(3):
                    try:
                        preview = perform_head_swap(
                            target_image_path=src_path,
                            face_image_path=character_image_path,
                            output_filename=out_path,
                            face_url_cached=None,
                        )
                        if preview and os.path.exists(preview):
                            out_path = preview
                            break  # Success, exit retry loop
                    except Exception as e:
                        print(f"   ⚠️  Attempt {attempt + 1}/3 failed for {filename}: {e}")
                        if attempt < 2:
                            time.sleep(5)  # 5 second delay before retry
                        continue

                os.environ["SEGMIND_SINGLE_ATTEMPT"] = "0"
                os.environ["SEGMIND_NO_TRY_FILES"] = "0"
                os.environ.pop("SEGMIND_ATTEMPT_INDEX", None)
            else:
                shutil.copyfile(src_path, out_path)'''

content = content.replace(old_code, new_code)

# Write back
with open('Codes/image_processor.py', 'w') as f:
    f.write(content)

print("Patch applied successfully!")
PATCH_EOF

# Step 5: Run the patch
python3 /tmp/fix_patch.py

# Step 6: Restart the API service
# If using systemd:
systemctl restart storyapi

# Or if running manually:
# pkill -f uvicorn
# nohup python3 -m uvicorn Api.api_story:app --host 0.0.0.0 --port 8000 &

# ============================================================
# ALTERNATIVE: Quick manual edit
# ============================================================
# If the patch doesn't work, manually edit Codes/image_processor.py:

# 1. Find line 427 (should be: for filename in all_images:)
# 2. Change it to: for idx, filename in enumerate(all_images):
# 3. After line 437 (if is_api:), add these lines:
#     
#     # Add delay between API calls to avoid rate limiting
#     if idx > 0:
#         time.sleep(2)
#
# 4. Replace the perform_head_swap block with retry logic:
#
#     preview = None
#     for attempt in range(3):
#         try:
#             preview = perform_head_swap(...)
#             if preview and os.path.exists(preview):
#                 out_path = preview
#                 break
#         except Exception as e:
#             print(f"Attempt {attempt+1}/3 failed: {e}")
#             if attempt < 2:
#                 time.sleep(5)
#             continue

echo "Done! Restart the API to apply changes."
